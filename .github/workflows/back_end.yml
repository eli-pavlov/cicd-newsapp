name: Backend CI/CD (via repo_dispatch)

on:
  repository_dispatch:
    types: [backend]
  workflow_dispatch:

permissions:
  contents: read

env:
  APP_NAME: newsapp-backend    # image name (not secret)

jobs:
  build-deploy-backend:
    if: github.event.action == 'backend'
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.event.client_payload.branch }}
      COMMIT_SHA:  ${{ github.event.client_payload.commit_sha }}
      SHORT_SHA:   ${{ github.event.client_payload.short_sha }}
    steps:
      - name: Validate payload
        run: |
          test -n "${BRANCH_NAME}" && test -n "${COMMIT_SHA}" && test -n "${SHORT_SHA}"

      - name: Checkout backend source at sent commit
        run: |
          git config --global advice.detachedHead false
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/ghGill/newsAppBackend.git app
          cd app
          git fetch --all --tags
          git checkout "${COMMIT_SHA}"

      - name: Set image tag & environment
        run: |
          if [ "${BRANCH_NAME}" = "main" ]; then
            TAG="latest-${SHORT_SHA}"
            ENVIRONMENT="production"
          else
            TAG="dev-${SHORT_SHA}"
            ENVIRONMENT="development"
          fi
          echo "TAG=${TAG}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV

      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push
        uses: docker/build-push-action@v4
        with:
          context: ./app
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:${{ env.TAG }}

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update image in manifests repo
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"

          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/eli-pavlov/github-actions-cicd-manifests.git manifests
          # If you keep per-component overlays, change path accordingly:
          cd manifests/manifests/overlays/${ENVIRONMENT}

          kustomize edit set image ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.APP_NAME }}:${{ env.TAG }}

          git add kustomization.yaml
          git commit -m "BE CI: ${APP_NAME} -> ${TAG} (${SHORT_SHA}) for ${ENVIRONMENT}" || echo "Nothing to commit"
          git push
